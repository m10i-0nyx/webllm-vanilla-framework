---
applyTo: "**"
---

# WebLLM Vanilla Framework 実装ガイドライン

## 概要

- WebGPUを活用するWebLLMのフロントエンドアプリケーションを提供すること

## アーキテクチャ
- WebLLM : https://github.com/mlc-ai/web-llm
- 開発言語はTypeScriptを使用すること
- パッケージマネージャーはpnpmを使用すること

## 基本
- 日本語で回答してください
- 必要に応じて、ユーザに質問を行い、要求を明確にすること
- 作業後、作業内容とユーザが次に取れる行動を説明すること
- 作業項目が多い場合は、段階に区切り、git commit を行いながら進めること
  - semantic commit を使用する
  - コミットメッセージは英語で記述すること
  - コミットメッセージの最初は add, fix, modify, clean のいずれかで始めること
- 簡潔で分かりやすい説明を心がけてください
- ベストプラクティスの具体例を提示してください
- 学習リソースの提案を積極的に行ってください
- 常に日本語で分かりやすい言葉を選び、丁寧な表現を心がけてください
- スケーラビリティとパフォーマンスを重点的にチェックしてください

## コードレビュー専用指示
### レビューの基本方針
以下のプレフィックスを使用してレビューコメントを分類してください：
- `[must]` - 必須修正項目（セキュリティ、バグ、重大な設計問題）
- `[recommend]` - 推奨修正項目（パフォーマンス、可読性の大幅改善）
- `[nits]` - 軽微な指摘（コードスタイル、タイポ等）

## 実装履歴

### セキュリティ対策
実装日: 2026-02-21

**実装内容:**
- **XSS対策**: `innerHTML` → `createElement` + `textContent` に変更
- **入力値検証**: メッセージ長の制限（最大2000文字）
- **モデル検証**: ホワイトリスト照合による型安全な実装
- **レート制限**: 日次リクエスト上限1000に設定
- **タイムアウト**: 120秒のリクエストタイムアウト実装
- **エラーハンドリング**: 詳細情報をコンソールのみに表示
- **メモリ管理**: チャット履歴を最大50メッセージに制限

### IndexedDB永続化機能
実装日: 2026-02-21

**実装内容:**
- **永続化**: IndexedDBを使用して会話履歴をブラウザiに保存
- **自動読み込み**: アプリケーション起動時に過去の会話を自動復元
- **手動クリア**: Clear履歴をクリアするボタンと確認ダイアログ
- **トランザクション管理**: IDBトランザクションで安全なデータ操作

**主要機能:**
- `initializeDatabase()`: IndexedDB初期化
- `saveMessage()`: メッセージをDBに保存
- `loadMessages()`: 保存されたメッセージを読み込み
- `clearMessages()`: 全メッセージを削除

**ストレージ構成:**
```
データベース: WebLLMChat (v1)
オブジェクトストア: messages
- キー: id (autoIncrement)
- インデックス: timestamp (昇順)
- 制限: 最大50メッセージ
```
### Markdown表示機能
実装日: 2026-02-23

**実装内容:**
- **Markdown対応**: `marked` ライブラリでMarkdownをHTMLに変換
- **XSS対策**: `DOMPurify` を使用した厳密なサニタイズ
- **許可タグ設定**: スクリプト実行を完全に防止し、フォーマットタグのみ許可
- **エラーハンドリング**: Markdown解析失敗時はプレーンテキストで表示
- **選別レンダリング**: ユーザーメッセージはテキスト、AIメッセージはMarkdownで表示

**セキュリティ設定:**
```typescript
const PURIFY_CONFIG = {
    ALLOWED_TAGS: [
        'p', 'br', 'strong', 'em', 'u', 'del', 'h1', 'h2', 'h3', 'h4', 'h5', 'h6',
        'blockquote', 'code', 'pre', 'ul', 'ol', 'li', 'a',
        'img', 'table', 'thead', 'tbody', 'tr', 'th', 'td', 'hr'
    ],
    ALLOWED_ATTR: ['href', 'title', 'alt', 'src'],
    KEEP_CONTENT: true,
}
```

**主要機能:**
- `renderMarkdownString()`: Markdownを安全なHTMLに変換
- `renderMessage()`: ロール別の適切なレンダリング

**対応フォーマット:**
- 見出し（H1-H6）、段落、改行、強調、リンク、コードブロック
- リスト（順序付き・非順序付き）、引用ブロック
- テーブル、水平線
